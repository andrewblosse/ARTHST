---
title: "Main_RMD"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(colorspace)
library(priceR)
```

```{r read-data, include = FALSE}
knoedler <- read_csv("knoedler.csv")
knoedler <- knoedler %>%
  filter(object_type == "Painting") %>%
  mutate(price_amount = as.numeric(price_amount))
```

```{r glimpse-data}
knoedler %>%
  count(sell_auth_loc_1) %>%
  arrange(desc(n))
```
```{r year-hist-plot, warning=FALSE}
 yearhistogram <- knoedler %>%
  ggplot(aes(x = sale_date_year)) +
  geom_histogram(bins = 100, fill = "lightblue") +
  labs(title = "Painting Sales vs Year of Sale",
       subtitle = "Paintings sold by M. Knoedler & Co.",
       x = "Year of Sale",
       y = "Number of Paintings Sold") +
  theme_classic()

year_price_scatter <- knoedler %>%
  ggplot(aes(x = sale_date_year, y = price_amount)) +
  geom_point() +
  geom_smooth(color = "green") +
  theme_minimal() +
  labs(title = "Scatterplot of Painting Price vs Sale Year",
       x = "Year of Sale",
       y = "Price in USD") +
  scale_y_continuous(breaks = c(100000, 200000, 300000, 400000, 500000), labels = c("$100,000", "$200,000", "$300,000", "$400,000", "$500,000"))
```

```{r density-plot-sales-price, warning=FALSE}
 price_histogram<- knoedler %>%
  ggplot(aes(x = price_amount, color = price_amount)) +
  geom_histogram(bins = 50, fill = "darkgreen") +
  scale_x_continuous(limits = c(0, 30000)) +
  labs(title = "Knoedler Painting Sale Prices",
       x = "Price in USD",
       y = "# of Sales") +
  theme_classic()
  
```

```{r dimensions}
common_painting_dimensions <- knoedler %>%
  filter(!is.na(dimensions))%>%
  count(dimensions) %>%
  arrange(desc(n)) %>%
  head(20) %>%
  ggplot(aes(y = dimensions, x = n)) +
  geom_col() +
  labs(title = "Most Common Painting Dimensions",
       subtitle = "Paintings from M. Knoedler & Co. Stock Books",
       y = "Painting Dimension",
       x = "Frequency") +
  theme_minimal()
```

```{r avg-price-per-dim, warning=FALSE}
top20dims <- knoedler %>%
  filter(!is.na(dimensions)) %>%
  count(dimensions) %>%
  arrange(desc(n)) %>%
  head(20)

boxplots <- knoedler %>%
  filter(dimensions %in% top20dims$dimensions) %>%
  select(dimensions, price_amount, price_currency) %>%
  ggplot(aes(y = dimensions, x = price_amount)) +
  geom_boxplot() +
  coord_cartesian(xlim = c(0, 25000)) +
  labs(title = "Boxplots of Sale Prices by Dimension",
       x = "Price in USD",
       y = "Painting Dimensions in Inches")
```

```{r display, warning=FALSE}
#boxplots
#common_painting_dimensions
#price_histogram
#top20dims
#year_price_scatter
#yearhistogram
```

```{r dimension-wrangling}
# dims <- knoedler %>%
#   filter(!is.na(dimensions)) %>%
#   mutate(dimensions = gsub("\\[|\\]", "", dimensions)) 

#step1 - remove everything that isn't a number, a slash, or an x|X
knoedler_dimensions <- knoedler %>%
  mutate(dims_cleaned = str_replace_all(dimensions, "\\[|\\]", "")) %>%
  filter(!is.na(dimensions)) %>%
  mutate(dim1 = str_split(dims_cleaned, "x|X", simplify = TRUE)[,1],
         dim2 = str_split(dims_cleaned, "x|X", simplify = TRUE)[,2]) %>%
  mutate(dim1 = str_replace_all(dim1, "\\d/\\d", ""),
         dim2 = str_replace_all(dim2, "\\d/\\d", "")) %>%
  mutate(dim1 = str_replace_all(dim1, "[:alpha:]|[:punct:]", ""),
         dim2 = str_replace_all(dim2, "[:alpha:]|[:punct:]", "")) %>%
  mutate(dim1 = as.numeric(str_extract(dim1, "\\d\\d\\d|\\d\\d|\\d")),
         dim2 = as.numeric(str_extract(dim2, "\\d\\d\\d|\\d\\d|\\d"))) %>%
  mutate(inches_squared = dim1 * dim2)


```

```{r plots2, warning=FALSE}
dims_scatterplot <- knoedler_dimensions %>%
ggplot() +
  theme_classic() +
  geom_point(aes(x = dim1, y = dim2, size = price_amount, color = price_amount), alpha = .5) +
  scale_color_viridis_c(direction = -1, labels = c("$50,000","$100,000","$200,000","$400,000","$600,000"), breaks = c(50000, 100000, 200000, 400000, 600000), begin = 0, end = 1) +
  scale_size_continuous(labels = c("$50,000", "$100,000","$200,000","$400,000","$600,000"), breaks = c(50000 ,100000, 200000, 400000, 600000)) +
  geom_abline(slope = 1.6, intercept = 0, color = "black", size = 1, linetype = 2) +
  geom_abline(slope = 1/1.6, intercept = 0, color = "black", size = 1, linetype = 2) +
  coord_cartesian(xlim = c(0, 175),
                  ylim = c(0, 175)) +
  guides(color = guide_legend(), size = guide_legend()) +
  labs(title = "Painting Dimensions and Sale Price",
       x = "Length in Inches",
       y = "Width in Inches",
       color = "Price in Dollars",
       size = "Price in Dollars",
       caption = "The Golden Ratio is denoted by the dotted lines")

subject_size_boxplots <- knoedler_dimensions %>%
  filter(!is.na(subject)) %>%
ggplot() +
  geom_boxplot(aes(x = inches_squared, y = fct_reorder(subject, inches_squared, .fun = median), color = subject)) +
  scale_x_log10() +
  theme_classic() +
  labs(title = "Size of Paintings by Subject",
       caption = "Painting Sizes & Subjects from M. Knoedler & Co. Stock Books",
       x = "Size in Inches Squared",
       y = "Subject") +
  scale_color_discrete_qualitative() +
  theme(legend.position = "none")

subject_price_boxplots<- knoedler %>%
  filter(!is.na(subject), !is.na(price_amount)) %>%
  group_by(subject) %>%
  summarise(mean_price = mean(price_amount)) %>%
  ggplot(aes(y = fct_reorder(subject, mean_price), x = mean_price, fill = subject)) +
  theme_classic() +
  geom_col() +
  scale_x_sqrt() +
  scale_fill_discrete_qualitative() +
  theme(legend.position = "none") +
  labs(title = "Mean Painting Sales Price by Subject", 
       x = "Mean Painting Price in USD",
       y = "Subject")

dims_scatterplot
subject_size_boxplots
subject_price_boxplots
```

#linear regressions

```{r moreplots}
#golden ratio closeness vs sale price
#raw size vs price

golden_ratio_plot <- knoedler_dimensions %>%
  mutate(ratio1 = dim1/dim2,
         ratio2 = dim2/dim1,
         bigratio = if_else(ratio1 >= ratio2, ratio1, ratio2),
         difference = abs(1.618 - bigratio)) %>%
  select(price_amount, difference) %>%
  filter(!is.na(price_amount)) %>%
  ggplot(aes(x = difference, y = price_amount)) +
  geom_point(aes(color = difference)) +
  scale_color_continuous_sequential(palette = "ag_GrnYl")

# ggplot() +
#   geom_point(aes(x = mincloseness, y = price_amount))

frequency_subject_plot <- knoedler_dimensions %>%
  filter(!is.na(subject)) %>%
  count(subject) %>%
  ggplot(aes(x = n, y = fct_reorder(subject, n), fill = n)) +
  geom_col() +
  scale_fill_continuous_qualitative() +
  theme(legend.position = "none") +
  labs(x = "Frequency",
       y = "Subject",
       title = "Frequency of Knoedler Subjects",
       caption = "Data from M. Knoedler & Co Stockbooks") +
  geom_text(aes(x = n + 17, y = fct_reorder(subject, n), label = as.character(n)))
```



